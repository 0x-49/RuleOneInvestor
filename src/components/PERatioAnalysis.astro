---
import { Card, CardContent, CardHeader, CardTitle } from '../client/src/components/ui/card'; // Assuming UI components are React
import { Badge } from '../client/src/components/ui/badge'; // Assuming UI components are React
import { Button } from '../client/src/components/ui/button'; // Assuming UI components are React
import { Tooltip, TooltipContent, TooltipTrigger } from '../client/src/components/ui/tooltip'; // Assuming UI components are React
import { BarChart3, Target, Info, TrendingUp, TrendingDown, Calculator, DollarSign } from 'lucide-react'; // Keep for now, will address later
// Recharts and Framer Motion are React-specific and will not work directly in a static Astro component.
// import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, LineChart, Line, Cell } from "recharts";
// import { motion } from "framer-motion";

interface PEData {
  period: string;
  pe: number;
  price: number;
  eps: number;
}

interface Props {
  symbol: string;
  currentPE: number;
  industryAvgPE: number;
  fairPE: number;
  historicalPE: PEData[];
  analystTargetPrice?: number;
  numAnalysts?: number;
}

const { symbol, currentPE, industryAvgPE, fairPE, historicalPE, analystTargetPrice, numAnalysts } = Astro.props;

// Prepare comparison data (for display, charting needs a different approach)
const comparisonData = [
  { name: 'Current P/E', value: currentPE, color: '#3b82f6' },
  { name: 'Industry Avg', value: industryAvgPE, color: '#6b7280' },
  { name: 'Fair P/E', value: fairPE, color: '#10b981' }
];

// Determine P/E status
const getPEStatus = () => {
  if (currentPE < industryAvgPE * 0.8) {
    return { status: "Attractive", color: "text-green-600", bg: "bg-green-50" };
  } else if (currentPE > industryAvgPE * 1.2) {
    return { status: "Expensive", color: "text-red-600", bg: "bg-red-50" };
  } else {
    return { status: "Reasonable", color: "text-amber-600", bg: "bg-amber-50" };
  }
};

const peStatus = getPEStatus();

// Calculate P/E trends
const recentPE = historicalPE.slice(-5);
const peChange = recentPE.length >= 2 ?
  ((recentPE[recentPE.length - 1].pe - recentPE[0].pe) / recentPE[0].pe) * 100 : 0;

// Calculate historical P/E stats
const historicalPEValues = historicalPE.map(d => d.pe);
const fiveYearHighPE = historicalPEValues.length > 0 ? Math.max(...historicalPEValues) : 0;
const fiveYearLowPE = historicalPEValues.length > 0 ? Math.min(...historicalPEValues) : 0;
const fiveYearAvgPE = historicalPEValues.length > 0 ? historicalPEValues.reduce((sum, d) => sum + d, 0) / historicalPEValues.length : 0;
---

<div class="space-y-6">
  {/* P/E Comparison Overview */}
  <Card>
    <CardHeader>
      <CardTitle className="flex items-center justify-between">
        <div class="flex items-center space-x-2">
          <BarChart3 className="h-5 w-5" />
          <span>Price-to-Earnings Analysis</span>
        </div>
        <Badge className={`${peStatus.bg} ${peStatus.color} border-0`}>
          {peStatus.status} Valuation
        </Badge>
      </CardTitle>
    </CardHeader>
    <CardContent>
      {/* Key P/E Metrics */}
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
        <div
          class="text-center p-4 bg-blue-50 rounded-lg border"
        >
          <div class="text-2xl font-bold text-blue-600">{currentPE.toFixed(1)}x</div>
          <div class="text-sm text-gray-600">Current P/E</div>
          <div class="text-xs text-gray-500 mt-1">
            {peChange >= 0 ? '+' : ''}{peChange.toFixed(1)}% vs 5Y avg
          </div>
        </div>

        <div
          class="text-center p-4 bg-gray-50 rounded-lg border"
        >
          <div class="text-2xl font-bold text-gray-600">{industryAvgPE.toFixed(1)}x</div>
          <div class="text-sm text-gray-600">Industry Average</div>
          <div class="text-xs text-gray-500 mt-1">
            {((currentPE - industryAvgPE) / industryAvgPE * 100).toFixed(0)}% premium
          </div>
        </div>

        <div
          class="text-center p-4 bg-green-50 rounded-lg border"
        >
          <div class="text-2xl font-bold text-green-600">{fairPE.toFixed(1)}x</div>
          <div class="text-sm text-gray-600">Fair P/E</div>
          <Tooltip>
            <TooltipTrigger>
              <div class="text-xs text-gray-500 mt-1 cursor-help">
                Rule One Calculation <Info className="h-3 w-3 inline ml-1" />
              </div>
            </TooltipTrigger>
            <TooltipContent>
              <p>Based on growth rate and quality factors</p>
            </TooltipContent>
          </Tooltip>
        </div>

        {analystTargetPrice && (
          <div
            class="text-center p-4 bg-purple-50 rounded-lg border"
          >
            <div class="text-2xl font-bold text-purple-600">${analystTargetPrice.toFixed(0)}</div>
            <div class="text-sm text-gray-600">Analyst Target</div>
            <div class="text-xs text-gray-500 mt-1">
              {numAnalysts || 0} analysts
            </div>
          </div>
        )}
      </div>

      {/* P/E Comparison Bar Chart - Recharts removed, placeholder div */}
      <div class="h-64 mb-6 bg-gray-100 flex items-center justify-center rounded-lg">
        <p class="text-gray-500">Chart Placeholder</p>
      </div>

      {/* P/E Analysis Summary */}
      <div class={`p-4 rounded-lg ${peStatus.bg} border`}>
        <h4 class={`font-semibold ${peStatus.color} mb-2`}>P/E Ratio Assessment</h4>
        <div class="space-y-2 text-sm">
          <p class={peStatus.color}>
            • {symbol}'s P/E of {currentPE.toFixed(1)}x is {currentPE > industryAvgPE ? 'above' : 'below'} industry average
          </p>
          <p class={peStatus.color}>
            • Trading at {((currentPE - fairPE) / fairPE * 100).toFixed(0)}% {currentPE > fairPE ? 'premium' : 'discount'} to calculated fair P/E
          </p>
          <p class={peStatus.color}>
            • Historical trend: P/E has {peChange >= 0 ? 'increased' : 'decreased'} by {Math.abs(peChange).toFixed(1)}% recently
          </p>
        </div>
      </div>
    </CardContent>
  </Card>

  {/* Historical P/E Trend */}
  <Card>
    <CardHeader>
      <CardTitle className="flex items-center space-x-2">
        <TrendingUp className="h-5 w-5" />
        <span>Historical P/E Ratio Trend</span>
      </CardTitle>
    </CardHeader>
    <CardContent>
      {/* Historical P/E Chart - Recharts removed, placeholder div */}
      <div class="h-80 bg-gray-100 flex items-center justify-center rounded-lg">
        <p class="text-gray-500">Chart Placeholder</p>
      </div>

      <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
        <div class="p-3 bg-blue-50 rounded-lg">
          <div class="text-lg font-bold text-blue-600">
            {fiveYearHighPE.toFixed(1)}x
          </div>
          <div class="text-sm text-gray-600">5Y High P/E</div>
        </div>
        <div class="p-3 bg-green-50 rounded-lg">
          <div class="text-lg font-bold text-green-600">
            {fiveYearLowPE.toFixed(1)}x
          </div>
          <div class="text-sm text-gray-600">5Y Low P/E</div>
        </div>
        <div class="p-3 bg-purple-50 rounded-lg">
          <div class="text-lg font-bold text-purple-600">
            {fiveYearAvgPE.toFixed(1)}x
          </div>
          <div class="text-sm text-gray-600">5Y Average</div>
        </div>
        <div class="p-3 bg-gray-50 rounded-lg">
          <div class="text-lg font-bold text-gray-600">
            {currentPE > fiveYearAvgPE ? 'Above' : 'Below'}
          </div>
          <div class="text-sm text-gray-600">vs Average</div>
        </div>
      </div>
    </CardContent>
  </Card>

  {/* P/E Explanation */}
  <Card>
    <CardHeader>
      <CardTitle className="flex items-center space-x-2">
        <Target className="h-5 w-5" />
        <span>Understanding P/E Ratios</span>
      </CardTitle>
    </CardHeader>
    <CardContent>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h4 class="font-semibold text-gray-800 mb-3">What P/E Tells You</h4>
          <div class="space-y-2 text-sm text-gray-600">
            <p>• <strong>Higher P/E:</strong> Investors expect higher earnings growth</p>
            <p>• <strong>Lower P/E:</strong> May indicate undervaluation or slower growth</p>
            <p>• <strong>Industry Context:</strong> Compare within same sector for relevance</p>
            <p>• <strong>Growth Rate:</strong> P/E should align with earnings growth rate</p>
          </div>
        </div>
        <div>
          <h4 class="font-semibold text-gray-800 mb-3">Rule One P/E Guidelines</h4>
          <div class="space-y-2 text-sm text-gray-600">
            <p>• <strong>Fair P/E:</strong> Typically equals earnings growth rate</p>
            <p>• <strong>Quality Factor:</strong> Higher quality companies warrant premium</p>
            <p>• <strong>Safety Margin:</strong> Buy below calculated fair P/E</p>
            <p>• <strong>Historical Context:</strong> Consider company's P/E range</p>
          </div>
        </div>
      </div>
    </CardContent>
  </Card>
</div>
